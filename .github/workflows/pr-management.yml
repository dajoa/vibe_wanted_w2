name: PR Management

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

jobs:
  pr-comment:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
    - name: PR ì²´í¬ë¦¬ìŠ¤íŠ¸ ëŒ“ê¸€ ì¶”ê°€
      uses: actions/github-script@v7
      with:
        script: |
          const body = `
          ## PR ì²´í¬ë¦¬ìŠ¤íŠ¸ âœ…
          
          PR ì‘ì„±ìëŠ” ë‹¤ìŒ í•­ëª©ë“¤ì„ í™•ì¸í•´ì£¼ì„¸ìš”:
          
          ### ì½”ë“œ í’ˆì§ˆ
          - [ ] SOLID ì›ì¹™ì„ ì¤€ìˆ˜í–ˆìŠµë‹ˆë‹¤
          - [ ] Clean Architectureë¥¼ ì ìš©í–ˆìŠµë‹ˆë‹¤
          - [ ] í•¨ìˆ˜ì™€ í´ë˜ìŠ¤ê°€ ì ì ˆí•œ í¬ê¸°ì…ë‹ˆë‹¤
          
          ### í…ŒìŠ¤íŠ¸
          - [ ] ìƒˆë¡œìš´ ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤
          - [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•©ë‹ˆë‹¤
          - [ ] TDD í”„ë¡œì„¸ìŠ¤ë¥¼ ë”°ëìŠµë‹ˆë‹¤
          
          ### ë¬¸ì„œí™”
          - [ ] í•„ìš”í•œ ê²½ìš° READMEë¥¼ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤
          - [ ] API ë³€ê²½ì‚¬í•­ì„ ë¬¸ì„œí™”í–ˆìŠµë‹ˆë‹¤
          - [ ] ì½”ë“œì— ì ì ˆí•œ ì£¼ì„ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤
          
          ### ê¸°íƒ€
          - [ ] ê´€ë ¨ ì´ìŠˆë¥¼ ë§í¬í–ˆìŠµë‹ˆë‹¤
          - [ ] ìŠ¤í¬ë¦°ìƒ·ì„ ì²¨ë¶€í–ˆìŠµë‹ˆë‹¤ (UI ë³€ê²½ ì‹œ)
          - [ ] ë¸Œëœì¹˜ëª…ì´ ê·œì¹™ì— ë§ìŠµë‹ˆë‹¤
          
          ---
          *ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
          `;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  pr-assigner:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
    - name: PR ìƒì„±ìì—ê²Œ ìë™ í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.addAssignees({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            assignees: [context.payload.pull_request.user.login]
          });

  pr-labeler:
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: íŒŒì¼ ë³€ê²½ì‚¬í•­ ê¸°ë°˜ ë¼ë²¨ë§
      uses: actions/github-script@v7
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          const labels = new Set();
          
          // íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ ë¼ë²¨ë§
          for (const file of files) {
            if (file.filename.startsWith('backend/')) {
              labels.add('backend');
            }
            if (file.filename.startsWith('frontend/')) {
              labels.add('frontend');
            }
            if (file.filename.startsWith('docs/') || file.filename.endsWith('.md')) {
              labels.add('documentation');
            }
            if (file.filename.includes('test')) {
              labels.add('tests');
            }
            if (file.filename.endsWith('.yml') || file.filename.endsWith('.yaml')) {
              labels.add('ci/cd');
            }
          }
          
          // PR ì œëª© ê¸°ë°˜ ë¼ë²¨ë§
          const title = context.payload.pull_request.title.toLowerCase();
          if (title.includes('bug') || title.includes('fix')) {
            labels.add('bug');
          }
          if (title.includes('feature') || title.includes('feat')) {
            labels.add('enhancement');
          }
          if (title.includes('docs')) {
            labels.add('documentation');
          }
          if (title.includes('refactor')) {
            labels.add('refactoring');
          }
          
          // í¬ê¸° ê¸°ë°˜ ë¼ë²¨ë§
          const changedLines = files.reduce((sum, file) => sum + file.changes, 0);
          if (changedLines < 50) {
            labels.add('size/S');
          } else if (changedLines < 200) {
            labels.add('size/M');
          } else if (changedLines < 500) {
            labels.add('size/L');
          } else {
            labels.add('size/XL');
          }
          
          if (labels.size > 0) {
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: Array.from(labels)
            });
          }

  auto-review:
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ìë™ ì½”ë“œ ë¦¬ë·° ëŒ“ê¸€
      uses: actions/github-script@v7
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          let reviewComments = [];
          
          for (const file of files) {
            // Python íŒŒì¼ ì²´í¬
            if (file.filename.endsWith('.py')) {
              // íŒŒì¼ í¬ê¸° ì²´í¬
              if (file.changes > 300) {
                reviewComments.push(`âš ï¸ **${file.filename}**: ì´ íŒŒì¼ì˜ ë³€ê²½ì‚¬í•­ì´ í½ë‹ˆë‹¤ (${file.changes} lines). ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`);
              }
              
              // í…ŒìŠ¤íŠ¸ íŒŒì¼ ì²´í¬
              if (!file.filename.includes('test') && file.status === 'added') {
                reviewComments.push(`ğŸ§ª **${file.filename}**: ìƒˆë¡œìš´ íŒŒì¼ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
              }
            }
          }
          
          if (reviewComments.length > 0) {
            const body = `
            ## ìë™ ì½”ë“œ ë¦¬ë·° ğŸ¤–
            
            ${reviewComments.join('\n\n')}
            
            ---
            *ì´ ë¦¬ë·°ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•´ì£¼ì„¸ìš”.*
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          } 